function shuffle(b){for(var a,d,f=b.length;f;a=Math.floor(Math.random()*f),d=b[--f],b[f]=b[a],b[a]=d);return b}function randomInit(b){for(var a=b.slice(0),d=0;d<b.length;d++)a[d]=Math.random();return a}
function Position(b){this.elements=b;this.move=function(a){for(var d in a.elements)this.elements[d]+=a.get(d);return this};this.addVector=function(a){var d=this.elements.slice(0),b;for(b in a)d[b]+=a.get(b);return new Position(d)};this.equal=function(a){return this.elements==v.elements};this.get=function(a){return this.elements[a]};this.setX=function(a){this.elements[0]=a};this.setY=function(a){this.elements[1]=a};this.setZ=function(a){this.elements[2]=a};this.getX=function(){return this.elements[0]};
this.getY=function(){return this.elements[1]};this.getZ=function(){return this.elements[2]};this.getDimention=function(){return this.elements.length}}
function Vector(b){this.elements=b;this.add=function(a){var d=this.elements.slice(0),b;for(b in d)d[b]+=a.get(b);return new Vector(d)};this.substract=function(a){var b=this.elements.slice(0),f;for(f in b)b[f]-=a.get(f);return new Vector(b)};this.multiple=function(a){var b=this.elements.slice(0),f;for(f in b)b[f]*=a;return new Vector(b)};this.interiorProduct=function(a){var b=0,f=this.elements.slice(0),k;for(k in f)b+=f[k]*a.get(k);return b};this.equal=function(a){return this.elements==a.elements};
this.set=function(a,b){this.elements[a]=b;return this.elements[a]};this.get=function(a){return this.elements[a]};this.setX=function(a){this.elements[0]=a};this.setY=function(a){this.elements[1]=a};this.setZ=function(a){this.elements[2]=a};this.getX=function(){return this.elements[0]};this.getY=function(){return this.elements[1]};this.getZ=function(){return this.elements[2]}}
function Screen(b){b=document.getElementById(b);var a=b.getContext("2d"),d=b.width,f=b.height;b=d/2;var k=f/2,g=d-b,l=0-b,m=f-k,e=0-k;a.translate(0,f);a.scale(1,-1);a.translate(b,k);a.scale(30,30);this.drawAxis=function(){var a,b;a=new Position([0,e]);b=new Position([0,m]);this.drawLine(a,b,"red");a=new Position([l,0]);b=new Position([g,0]);this.drawLine(a,b,"red")};this.drawPixel=function(b,e,d){a.beginPath();a.arc(b.getX(),b.getY(),1/30*2,0,2*Math.PI);e?(a.fillStyle=d?d:"black",a.fill()):(a.strokeStyle=
d?d:"black",a.stroke(),a.closePath())};this.drawLine=function(b,e,d){a.strokeStyle=d?d:"black";a.beginPath();a.moveTo(b.getX(),b.getY());a.lineTo(e.getX(),e.getY());a.lineWidth=1/30;a.stroke();a.closePath()};this.drawEquation=function(a,b,e,d){var g;0==b?(a=-d*e/a,g=new Position([a,this.getMinY()]),a=new Position([a,this.getMaxY()])):0==a?(a=-d*e/b,g=new Position([this.getMinX(),a]),a=new Position([this.getMaxX(),a])):(g=new Position([this.getMinX(),(-a*this.getMinX()-d*e)/b]),a=new Position([this.getMaxX(),
(-a*this.getMaxX()-d*e)/b]));this.drawLine(g,a)};this.clear=function(){a.clearRect(l,e,g-l,m-e)};this.getWidth=function(){return d};this.getHeight=function(){return f};this.getMaxX=function(){return g};this.getMinX=function(){return l};this.getMaxY=function(){return m};this.getMinY=function(){return e}}function Sample(b,a){this.position=b;this.group=a;this.getVector=function(){return new Vector(b.elements.slice(0))}}
function Weight(b){var a=new Vector(Array(b?b:2));this.set=function(b){a=b};this.get=function(){return a}}
function Perceptron(){var b=new Vector([-1,0,1]),a=0.8,d=[0,1],f=new Vector([-1,0,0]),k=0,g=0;this.setLearningRate=function(b){a=b};this.setGroups=function(a){d=a};this.setWeight=function(a){b=a};this.getGroups=function(){return d};this.getWeight=function(){return b};this.getTreshold=function(){return b.get(0)};this.caculateOutput=function(a){f=a;return k=1/(1+Math.exp(-b.interiorProduct(a)))};this.getOutput=function(){return k};this.calculateGradientOfOutputLayer=function(a){return g=(a-k)*k*(1-
k)};this.calculateGradient=function(a,b){var e=0,d;for(d in a)e+=a[d]*b[d];return g=k*(1-k)*e};this.getGradient=function(){return g};this.adjustWeight=function(d){b=b.add(f.multiple(a*g));d&&d(b)}}
function TestPerceptron(){var b,a,d,f=this,k=[],g,l,m,e,s=-1,q=0;this.setup=function(){b=new Screen("screen");document.getElementById("output").onchange=function(){this.scrollTop=this.scrollHeight};document.getElementById("file").onchange=function(a){if(window.File&&window.FileReader&&window.FileList&&window.Blob){a=a.target.files;var b=new FileReader;b.onload=function(a){return function(a){document.getElementById("input").innerText=a.target.result;y(a.target.result)}}(a[0]);b.readAsText(a[0])}else alert("The File APIs are not fully supported in your browser.\nPlease copy the sample to the input area.")};
document.getElementById("init").onclick=function(){b.clear();b.drawAxis();y(document.getElementById("input").value);a=u(document.getElementById("train-data").value);d=u(document.getElementById("test-data").value);var e=b,n=a,c=w(n),h=Math.round(16777215/c.length);if(2==n[0].position.getDimention())for(var g in n){var k=(h*c.indexOf(n[g].group)).toString(16),k=("000000"+k).substring(k.length-1,k.length+5);e.drawPixel(n[g].position,!0,"#"+k)}f.init()};document.getElementById("train").onclick=function(){var a=
parseInt(document.getElementById("condition-rd-value").value),b=parseFloat(document.getElementById("condition-eav-value").value),c=0,e=function(){var d=f.train();x("Round "+c+": Eav="+d.Eav+", Acc:"+d.Acc);c++;c<a&&d.Eav>b&&setTimeout(e,0)};e()};document.getElementById("test").onclick=function(){b.clear();b.drawAxis();f.test()}};this.init=function(){k=w(a);g;l;m;e;s=-1;for(var b=parseInt(prompt("\u96b1\u85cf\u5c64\u5c64\u6578")),d=[],c=0;c<b;c++)d.push(parseInt(prompt("\u7b2c"+(c+1)+"\u96b1\u85cf\u5c64\u500b\u6578")));
c=parseInt(prompt("\u8f38\u51fa\u5c64\u5c64\u6578"));d.push(c);alert("\u5404\u5c64\u6578: "+d.toString());c=d.reduce(function(a,b){return a+b});alert("\u795e\u7d93\u5143\u6578: "+c.toString());l=Array(c);m=Array(c);e=Array(d.length);g=Array(c);for(var h=c=0;c<d.length;h+=d[c],c++)for(e[c]=[],b=0;b<d[c];b++)e[c].push(b+h);for(c=1;c<e.length;c++)for(d=e[c-1],b=0;b<e[c].length;b++)l[e[c][b]]=d;for(c=0;c<e.length-1;c++)for(d=e[c+1],b=0;b<e[c].length;b++)m[e[c][b]]=d;for(c=0;c<e[0].length;c++)b=a[0].position.getDimention(),
d=new Vector(randomInit(Array(b+1))),d.set(0,s),g[e[0][c]]=new Perceptron,g[e[0][c]].setWeight(d);for(c=1;c<e.length;c++)for(h=e[c-1].length,b=0;b<e[c].length;b++)d=new Vector(randomInit(Array(h+1))),d.set(0,s),g[e[c][b]]=new Perceptron,g[e[c][b]].setWeight(d)};this.train=function(){var b=q=0,d;for(d in a){for(var c=0;c<e[0].length;c++){var h=a[d].getVector();h.elements.unshift(s);g[e[0][c]].caculateOutput(h)}for(c=e[0].length;c<g.length;c++){for(var h=[],f=0;f<l[c].length;f++)h.push(g[l[c][f]].getOutput());
h.unshift(s);h=new Vector(h);g[c].caculateOutput(h)}for(c in e[e.length-1])h=g[e[e.length-1][c]].getOutput(),a[d].group==k[Math.floor(h*k.length)]&&b++;for(c=0;c<e[e.length-1].length;c++){var r=k.indexOf(a[d].group)/(k.length-1),h=e[e.length-1][c];g[h].calculateGradientOfOutputLayer(r)}for(c=g.length-e[e.length-1].length-1;0<=c;c--){for(var r=[],z=[],f=0;f<m[c].length;f++){var h=m[c][f],p=g[h].getWeight(),A=g[h].getGradient();z.push(p.get(l[h].indexOf(c)+1));r.push(A)}g[c].calculateGradient(r,z)}for(c=
0;c<g.length;c++)g[c].getWeight(),g[c].adjustWeight();for(c in g);for(c=f=0;c<e[e.length-1].length;c++)r=k.indexOf(a[d].group)/(k.length-1),h=e[e.length-1][c],h=r-g[h].getOutput(),f+=h*h;f/=2;q+=f}q/=a.length;return{Eav:q,Acc:b/a.length}};this.test=function(){var f=0,n;for(n in d){for(var c=0;c<e[0].length;c++){var h=d[n].getVector();h.elements.unshift(s);g[e[0][c]].caculateOutput(h)}for(c=e[0].length;c<g.length;c++){for(var h=[],t=0;t<l[c].length;t++)h.push(g[l[c][t]].getOutput());h.unshift(s);h=
new Vector(h);g[c].caculateOutput(h)}for(c in e[e.length-1]){h=g[e[e.length-1][c]].getOutput();(t=d[n].group==k[Math.floor(h*k.length)])&&f++;var r=b,m=d[n],p=k[Math.floor(h*k.length)],q=w(a),u=Math.round(16777215/q.length);2==m.position.getDimention()&&(p=(u*q.indexOf(p?p:m.group)).toString(16),p=("000000"+p).substring(p.length-1,p.length+5),r.drawPixel(m.position,!0,"#"+p));x("test_sample"+n+"\t"+(t?"CORRECT":"WRONG")+"\texpect: "+d[n].group+", output: "+k[Math.floor(h*k.length)])}}x("Test Acc: "+
f/d.length)};this.run=function(){};var u=function(a){var b=[];a=a.split("\n");for(var c in a)if(""!=a[c]){var d=a[c].match(/[+\-]?\d+(\.\d+)?/g),e;for(e in d)d[e]=parseFloat(d[e]);b.push(new Sample(new Position(d.slice(0,d.length-1)),d[d.length-1]))}return b},y=function(a){a=a.split("\n");var b=a.length,c=Math.floor(2*b/3),b=b-c,d="",e="";shuffle(a);for(var f=0;f<c;f++)d+=a.shift()+"\n";for(f=0;f<b;f++)e+=a.shift()+"\n";document.getElementById("train-data").innerText=d;document.getElementById("test-data").innerText=
e},w=function(a){var b=[],c;for(c in a)-1==b.indexOf(a[c].group)&&b.push(a[c].group);return b},x=function(a){var b=document.getElementById("output");b.value+=a+"\n";b.scrollTop=b.scrollHeight}}var app=new TestPerceptron;app.setup();
